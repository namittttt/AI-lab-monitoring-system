import express from 'express';
import dotenv from 'dotenv';
import http from 'http';
import morgan from 'morgan';
import path from 'path';
import cors from 'cors';
import cookieParser from 'cookie-parser';

import { connectDB } from './lib/db.js';

// Routes
import detectionRoutes from './routes/detection.route.js';

// Models (only if you need to create default lab/setting; keep if used)
import Setting from './models/setting.model.js';
import Lab from './models/Lab.model.js';
import LabSession from './models/LabSession.model.js';

// Scheduler (start/stop persistent workers)
import { startSessionDetections, stopAllDetections } from './utils/scheduler.js';

dotenv.config();
const app = express();
const server = http.createServer(app);
const PORT = process.env.PORT || 5001;

// Middleware
app.use(cors({ origin: process.env.CLIENT_URL || '*' }));
app.use(express.json());
app.use(cookieParser());
app.use(morgan('dev'));

// Static files for screenshots
const screenshotsFolder = path.resolve(process.env.SCREENSHOTS_DIR || path.join(process.cwd(), 'screenshots'));
app.use('/screenshots', express.static(screenshotsFolder));

// API routes
app.use('/api/detections', detectionRoutes);

// optional health route
app.get('/health', (req, res) => res.json({ ok: true }));

// --- Server startup ---
const startServer = async () => {
  try {
    await connectDB();
    console.log('âœ… Connected to database');

    // ensure a default lab exists (optional)
    const defaultLabName = 'lab102';
    let lab = await Lab.findOne({ name: defaultLabName });
    if (!lab) {
      lab = await Lab.create({
        name: defaultLabName,
        capacity: 5,
        cameraStatus: 'online',
        cameraIP: '0',
        ipRange: '',
        currentUtilization: 0,
      });
      console.log(`ğŸ†• Created default lab: ${lab.name}`);
    }

    // ensure default setting exists (optional)
    let setting = await Setting.findOne({ key: 'default_detections_per_session' });
    if (!setting) {
      setting = await Setting.create({
        key: 'default_detections_per_session',
        value: Number(process.env.DEFAULT_DETECTIONS || 5),
      });
    }

    server.listen(PORT, () => {
      console.log(`ğŸš€ Server listening on port ${PORT}`);
    });
  } catch (err) {
    console.error('âŒ Failed to start server:', err);
    process.exit(1);
  }
};

startServer();

export default app;